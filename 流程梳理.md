### 机台一（-1入壳机

#### #0 软件界面

![image-20240205103245367](pic/image-20240205103245367.png)

#### #1卷芯直径检测

##### 1 检测需求

```
1. 测卷芯直径
2. 测中心孔是否通孔
```

##### 2 算法思路

```
1、定位找拟合圆
2、做一个圆的Blob（大小为钢壳）
3、将步骤1的图减去步骤2的blob图得出图像运算图（几何创建步骤待定），再做blob检测卷芯是否外翻大过钢壳导致无法顺利入壳
4、将步骤2找的圆做位置修正定位，在圆心处通孔做直方图检测，用均值/标准差作为图像是否通孔的依据
5、将步骤3找Blob模块状态和步骤4直方图模块状态两个变量作与运算，作为OK/NG的结果输出；
```

简易流程图：![image-20240205125811564](pic/image-20240205125811564.png)

步骤3：图像运算图![image-20240130194420066](pic/image-20240130194420066.png)

OK结果图：![image-20240131083646098](pic/image-20240131083646098.png)

NG结果图：![image-20240131083653877](pic/image-20240131083653877.png)

#### #2底垫、负极耳检测

##### 1 检测需求

```
1. 测底垫的偏移(含有无检测)
2. 极耳下压位置完全盖住中心孔
```

##### 2 算法思路

```
1、定位找极耳的位置和角度，若未找到模板=>NG，极耳角度偏差范围（-10~10）=>NG;
2、对极耳左右两边与下边作边缘交点，得出极耳下边的中点信息，同时找到载具的拟合圆心
3、将步骤2的得到的中点的x1、y1与圆心的x0、y0作差(一般情况下，y-为正数，x-为在-y1*tan10°，y1*tan10°)，两个条件都满足极耳才算遮挡通孔。
4、将步骤2测的圆用Blob显示出并作图像运算减，超出载具部分用Blob检出
5、将步骤3通孔遮挡的结果和步骤4顶垫偏移结果做与运算，作为OK/NG的结果输出；
```

简易流程图：![image-20240205131315403](pic/image-20240205131315403.png)

步骤1：找极耳图![image-20240131084448553](pic/image-20240131084448553.png)

步骤4：图像运算减![image-20240131091307008](pic/image-20240131091307008.png)

OK结果图：![image-20240131091710279](pic/image-20240131091710279.png)

NG结果图：![image-20240131091720067](pic/image-20240131091720067.png)

### 机台二（-2点底焊机

#### #0 软件界面

![image-20240205102309824](pic/image-20240205102309824.png)

#### #1卷芯中心孔检测

##### 1 检测需求

```
1、测中心孔是否堵孔
```

##### 2 算法思路

```
1、定位找圆心做跟随
2、对圆心处做直方图处理，用均值/标准差作为图像是否通孔的依据
3、根据步骤2直方图结果的作为OK/NG的结果输出；
```

简易流程图：![image-20240205131501732](pic/image-20240205131501732.png)

OK结果图：![image-20240131094345934](pic/image-20240131094345934.png)

NG结果图：![image-20240131094353849](pic/image-20240131094353849.png)

### 机台三（-3盖帽铆接机

#### #0 软件界面

![image-20240205102520208](pic/image-20240205102520208.png)

#### #1顶针入孔检测

##### 1 检测需求

```
1、判断顶针是否入孔
```

##### 2 算法思路

```
1、定位找极耳圆孔（原图视野大，可能还需要做粗定位）
2、将步骤1找到的极耳圆孔做直方图检测
3、根据步骤2直方图结果的作为OK/NG的结果输出；
```

简易流程图：![image-20240205131501732](pic/image-20240205131501732.png)

NG结果图：![image-20240131101524412](pic/image-20240131101524412.png)

#### #2铆接外观检测

##### 1 检测需求

```
1、极耳是否压紧(上下左右偏移)
2、垫片有无、是否压紧(无偏移)
3、注液孔的位置在极片的左/右(角度固定)
```

##### 2 算法思路

```
1、定位找注液孔位置，若匹配失败直接NG，条件检测结果为res1（不走为1）；
2、找注液孔和胶圈的拟合圆，得出注液孔偏移角度，若注液孔偏移角度不满足条件，则NG跳出，结果为res2（结果随检测）
3、将步骤2胶圈拟合圆的半径做变量计算处理，缩小范围匹配压环。若匹配成功找压环的拟合圆，若压环匹配失败，则Ng跳出，res3（不走为1）
4、将步骤3压环拟合圆与步骤2胶圈拟合圆做同心度检测，偏移距离控制在一定范围内，若超出范围NG跳出，res4（结果随检测）
5、将步骤3压环圆的半径作为Blob匹配区的内径，步骤1粗定位的匹配框宽度作为Bolb匹配区的外径（主要作用是得到二值化图像，找极耳的边）
6、在步骤5的做位置修正，同时做几何创建找极耳上边的“猫耳朵”，匹配失败结果为res5（不走为1），若“猫耳朵”匹配成功则做极耳上边的直线查找（这里直线查找在小范围和大范围找两次，避免出现直线查找找到极耳上偏移处极片向下弯折的直线导致漏检），再对极耳的左侧长边再做直线查找。
7、将步骤六极耳上边两次直线查找的线做线线测量，若两条线为同一条线为OK，反之为NG跳出，res6（不走为1）
8、将步骤6小范围直线查找得到的直线和步骤6极耳左侧长边做线线测量（角度在85~95）和点点测量（距离在200~255），当两个条件都满足时，极片位置检测OK；res7（不走则上面NG，为0）
9、将所有的if条件分支结果都集中在脚本（res1~res7与运算）上总体输出判断OK/NG输出；
```

简易流程图：![image-20240205135306881](pic/image-20240205135306881.png)

步骤1：注液孔匹配失败![image-20240131151251190](pic/image-20240131151251190.png)

步骤2：注液孔角度检测![image-20240131151417212](pic/image-20240131151417212.png)

步骤3：压环缺失![image-20240131151740834](pic/image-20240131151740834.png)

步骤4：压环偏移![image-20240131151948262](pic/image-20240131151948262.png)

步骤5：二值化找边![image-20240131152025390](pic/image-20240131152025390.png)

步骤6：找“猫耳朵“+极耳上*2、左边![image-20240131152159595](pic/image-20240131152159595.png)

![image-20240131152325584](pic/image-20240131152325584.png)

![image-20240131152351740](pic/image-20240131152351740.png)

步骤7：极耳两条上边检测![image-20240131152504607](pic/image-20240131152504607.png)

步骤8：极耳上、左两边夹角 + 交点与圆心的偏移关系

![image-20240131152626924](pic/image-20240131152626924.png)

![image-20240131152633260](pic/image-20240131152633260.png)

OK结果图：![image-20240131152756891](pic/image-20240131152756891.png)

NG结果图：![image-20240131152746719](pic/image-20240131152746719.png)

### 机台四（-4折极耳压盖机

#### #0 软件界面

![image-20240205102614096](pic/image-20240205102614096.png)

#### #1顶垫检测

##### 1 检测需求

```
顶垫有无、偏移检测
```

##### 2 算法思路

```
1、定位匹配顶垫的有无和角度，无顶垫或顶垫角度范围不在（-20~20）则直接NG
2、将步骤1所NG的无顶垫/角度大的情况用条件分支进一步判断，判断结果通向脚本（流程顺利执行）
3、做图像处理找顶垫中心孔的拟合圆，再对壳体做拟合圆处理。
4、将步骤3两个圆做同心度检测，得出偏移关系，判断结果通向脚本。（若步骤4未执行，则脚本输出0，步骤2仍能流向脚本往后执行变量计算）
5、变量计算为圆圆测量结果和顶垫检测的总结果，结果判断OK/NG的依据
```

简易流程图：![image-20240217094155419](img/image-20240217094155419.png)

步骤1：顶垫有无/角度判断![image-20240131165059944](pic/image-20240131165059944.png)

![image-20240131165108059](pic/image-20240131165108059.png)

![image-20240131165139313](pic/image-20240131165139313.png)

步骤4：顶垫中心孔和钢壳拟合圆做同心度检测

![image-20240131165235694](pic/image-20240131165235694.png)

OK结果图：![image-20240131165514716](pic/image-20240131165514716.png)

NG结果图：![image-20240131165532751](pic/image-20240131165532751.png)

![image-20240131165538974](pic/image-20240131165538974.png)

#### #2负极耳残留检测

##### 1 检测需求

```
极耳切割残留检出
```

##### 2 算法思路

```
1、定位找注液孔和钢壳外轮廓拟合圆，圆圆测量注液孔偏移角
2、将步骤1所得偏移角用变量计算处理，在该角度前/后通过+/-某个角度得到圆环展开的初始角、内、外径；
3、将步骤2所得初始角、内外径用于圆环展开，同时做直线边缘缺陷检测（缺陷距离阈值10pixels）
4、将步骤3直线边缘缺陷检测的结果作为判断OK/NG的依据
```

简易流程图：![image-20240205133453469](pic/image-20240205133453469.png)

步骤1：注液孔角度图![image-20240131183710593](pic/image-20240131183710593.png)

步骤3：圆环展开![image-20240131183735519](pic/image-20240131183735519.png)

步骤4：直线边缘检测![image-20240131183813782](pic/image-20240131183813782.png)

![image-20240131183835720](pic/image-20240131183835720.png)

OK结果图：![image-20240131183933491](pic/image-20240131183933491.png)

NG结果图：![image-20240131183950541](pic/image-20240131183950541.png)

### 机台五（-5激光焊接机

#### #0 软件界面

![image-20240205102804767](pic/image-20240205102804767.png)

#### #1焊接外观检测

##### 1 检测需求

```
对焊接封口检测，检测项：焊缝、沙眼
```

##### 2 算法思路

```
1、定位找料
2、图像增强（对比度250），方便找最小的焊边，圆查找最小焊边
3、将步骤2圆用Blob抠出，再做图像运算减处理
4、用深度学习图像分割出漏焊缺陷，再用Blob找出
5、结果输出，由于输出了缺陷面积，且缺陷面积不确定数量，且OK时不输出缺陷面积。因此用脚本判断面积缺陷状态，OK时则不走缺陷面积。另一条支路“结果”为OK/NG的判断
```

简易流程图：![image-20240205133636890](pic/image-20240205133636890.png)

步骤2图：图像增强 + 圆![image-20240201091420788](pic/image-20240201091420788.png)

![image-20240201091623357](pic/image-20240201091623357.png)

步骤3：图像运算减![image-20240201093454124](pic/image-20240201093454124.png)

步骤4：漏焊找出![image-20240201093843719](pic/image-20240201093843719.png)

OK结果图：![image-20240201094217878](pic/image-20240201094217878.png)

NG结果图：![image-20240201094205237](pic/image-20240201094205237.png)

### 机台六（-7注液机

#### #1注液孔定位纠偏

##### 1 检测需求

```
1、注液孔定位纠偏
```

##### 2 算法思路

```
1、匹配定位找圆，再找注液孔圆
2、几何创建两圆心间的直线X1，用线线测量直线X1与X轴Y = Oy的夹角作为偏移角度
```

简易流程图：

![image-20240205133729653](pic/image-20240205133729653.png)

步骤2：注液孔偏移角度![image-20240204165757406](pic/image-20240204165757406.png)

#### #2压钉缺陷检测

##### 1 检测需求

```
（已有良品、凹钉下陷、压钉凸起、顶盖压印、注液孔旁压印样品）
1、压钉检测，判断压钉有无、倒钉、钉凸、钉凹
2、压印检测，判断顶盖面压印有无、注液孔旁压印
3、高度检测，测量T头到电池底部的高度（顶盖面和注液孔压钉高度），电池整高。
```

##### 2 算法思路

```
1、对图像源做灰度变换，用于找圆定位和注液孔查找
2、快速匹配找圆定位，左侧高精度匹配找电池外轮廓；右侧图像增强使注液孔更明显，并用Blob找出，最后用圆查找订阅定位Blob位置找到注液孔。
3、将步骤2所得外轮廓圆O1和注液孔圆O2做圆圆测量，得出注液孔偏移角度
4.1、将步骤3得到的偏移角度做位置修正定位，用于Ⅰ）找顶盖平面度；Ⅱ）注液孔几何创建和统计测量；Ⅲ）顶盖面平面拟合；
4.2、将步骤2得到的电池轮廓做位置修正，其中角度为0，对电池极柱表面做“圆环形”几何创建并收集最高点，“夹爪”所在面进行平面拟合。最后一点一面做点面测量测电池整高
5.1、将步骤4的2）和3）做点面测量获取高度信息（该步骤可测压钉有无、倒钉、钉凸、钉凹和T头高度），若Ⅰ）该模块在1~200um => OK，结果res1；Ⅱ）在200~+∞ => 倒钉/钉凸，结果res2；Ⅲ）在-200~0um => 钉凹，结果res3；Ⅳ）在-∞~-200 => 无钉，结果为res4；
5.2、将步骤2所得外轮廓圆O1的半径缩小r1和r2，注液孔偏移角α+10为顶盖面检测的初始角，r1为平面检测圆环内径，r2为外径，角度范围为340°，检测该340度圆环的平整度（检测顶盖压印）
6、将1）的注液孔圆O2的半径扩大r3和r4得到圆环，内径r3，外径r4。r3完全囊括注液孔圆，r4为检测注液孔旁的平面度圆。根据平面检测获取该圆环的平面度，结果res5（检测注液孔旁压印）
7、将结果res1~res5在脚本中做判断检测（res2~res4不走为1，res1&res5为检测结果），输出结果作为判断OK/NG的依据
```

简易流程图：![image-20240301192020894](img/image-20240301192020894.png)

步骤1：灰度变换![image-20240204172909341](pic/image-20240204172909341.png)

步骤2：注液孔Bolb找出![image-20240204173014761](pic/image-20240204173014761.png)

步骤4.1：偏移角做位置修正，优化模板匹配失败问题![image-20240205084618742](pic/image-20240205084618742.png)

 步骤4.2：测电池整高

![image-20240301192151760](img/image-20240301192151760.png)

![image-20240301192215437](img/image-20240301192215437.png)

步骤5.1：平面拟合测高![image-20240205084946745](pic/image-20240205084946745.png)

步骤5.2：顶盖压印检测![image-20240205085255590](pic/image-20240205085255590.png)

步骤6：注液孔旁压印检测![image-20240205085351745](pic/image-20240205085351745.png)

